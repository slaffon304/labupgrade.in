<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ë–æ—Ç–∞ - Lab Upgrade</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –ø–æ–¥ —Å—Ç–∏–ª—å —Ç–≤–æ–µ–≥–æ —Å–∞–π—Ç–∞ */
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .card { background-color: #1e1e1e; border: 1px solid #333; width: 100%; max-width: 500px; }
        .form-control, .form-select { background-color: #2c2c2c; border: 1px solid #444; color: #fff; }
        .form-control:focus, .form-select:focus { background-color: #2c2c2c; color: #fff; border-color: #0d6efd; box-shadow: none; }
        .btn-facebook { background-color: #1877F2; color: white; border: none; font-weight: 600; }
        .btn-facebook:hover { background-color: #166fe5; color: white; }
        .hidden { display: none !important; }
        label { margin-bottom: 5px; color: #aaa; }
    </style>
</head>
<body>

<div class="card p-4 shadow-lg">
    <h3 class="text-center mb-4">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ë–∏–∑–Ω–µ—Å–∞</h3>
    
    <div id="step-login" class="text-center">
        <p class="text-muted mb-4">–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ Facebook, —á—Ç–æ–±—ã –ø–æ–¥–∫–ª—é—á–∏—Ç—å –±–æ—Ç–∞ –∫ –≤–∞—à–µ–π –±–∏–∑–Ω–µ—Å-—Å—Ç—Ä–∞–Ω–∏—Ü–µ.</p>
        <button class="btn btn-facebook w-100 py-3" onclick="signInWithFacebook()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-facebook me-2" viewBox="0 0 16 16">
                <path d="M16 8.049c0-4.446-3.582-8.05-8-8.05C3.58 0-.002 3.603-.002 8.05c0 4.017 2.926 7.347 6.75 7.951v-5.625h-2.03V8.05H6.75V6.275c0-2.017 1.195-3.131 3.022-3.131.876 0 1.791.157 1.791.157v1.98h-1.009c-.993 0-1.303.621-1.303 1.258v1.51h2.218l-.354 2.326H9.25V16c3.824-.604 6.75-3.934 6.75-7.951z"/>
            </svg>
            –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Facebook
        </button>
    </div>

    <div id="loading" class="text-center hidden py-5">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <p>–ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤–∞—à–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü...</p>
    </div>

    <div id="step-form" class="hidden">
        <div class="alert alert-success py-2">–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!</div>
        
        <form id="clientForm">
            <div class="mb-3">
                <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –±–æ—Ç–∞</label>
                <select class="form-select" id="fbPageSelect" required onchange="handlePageSelect()">
                    <option value="" disabled selected>–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å...</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">–ö–æ–º–ø–∞–Ω–∏—è</label>
                <input type="text" class="form-control" id="companyName" readonly required>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Telegram Bot Token (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <input type="text" class="form-control" id="tgToken" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 123456:ABC-DEF...">
            </div>

            <input type="hidden" id="fbPageId">
            <input type="hidden" id="fbAccessToken">
            <input type="hidden" id="igId">

            <button type="submit" class="btn btn-primary w-100 py-2 mt-2">–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ üöÄ</button>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    // ==========================================
    // –ù–ê–°–¢–†–û–ô–ö–ò (–í–°–¢–ê–í–¨ –°–í–û–ò –î–ê–ù–ù–´–ï –°–Æ–î–ê)
    // ==========================================
    const SUPABASE_URL = 'https://—Ç–≤–æ—è-—Å—Å—ã–ª–∫–∞.supabase.co'; 
    const SUPABASE_KEY = '—Ç–≤–æ–π-anon-key';
    // ==========================================

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let foundPages = []; // –¢—É—Ç –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–ª–∏–µ–Ω—Ç–∞

    // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ: –≤–µ—Ä–Ω—É–ª—Å—è –ª–∏ –∫–ª–∏–µ–Ω—Ç —Å Facebook?
    window.onload = async () => {
        const { data: { session } } = await supabase.auth.getSession();
        
        if (session) {
            // –ö–ª–∏–µ–Ω—Ç –≤–æ—à–µ–ª
            document.getElementById('step-login').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            // –ò–¥–µ–º –∑–∞ —Å–ø–∏—Å–∫–æ–º —Å—Ç—Ä–∞–Ω–∏—Ü
            fetchFacebookPages(session.provider_token);
        }
    };

    // 2. –ö–Ω–æ–ø–∫–∞ "–í–æ–π—Ç–∏"
    async function signInWithFacebook() {
        const { error } = await supabase.auth.signInWithOAuth({
            provider: 'facebook',
            options: {
                // –ü—Ä–æ—Å–∏–º –ø—Ä–∞–≤–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –ø–µ—Ä–µ–ø–∏—Å–∫—É
                scopes: 'pages_show_list,pages_messaging,pages_read_engagement,instagram_basic,instagram_manage_messages',
                redirectTo: window.location.href 
            }
        });
        if (error) alert('–û—à–∏–±–∫–∞ Supabase: ' + error.message);
    }

    // 3. –ó–∞–±–∏—Ä–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã —É Facebook API
    async function fetchFacebookPages(token) {
        try {
            const url = `https://graph.facebook.com/me/accounts?access_token=${token}&fields=name,access_token,id,instagram_business_account`;
            const response = await fetch(url);
            const result = await response.json();

            if (result.data && result.data.length > 0) {
                foundPages = result.data;
                const select = document.getElementById('fbPageSelect');
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
                foundPages.forEach((page, index) => {
                    const opt = document.createElement('option');
                    opt.value = index;
                    opt.text = page.name;
                    select.appendChild(opt);
                });

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('step-form').classList.remove('hidden');
            } else {
                alert('–ù–∞ —ç—Ç–æ–º –∞–∫–∫–∞—É–Ω—Ç–µ –Ω–µ—Ç –ø—É–±–ª–∏—á–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü (Fan Pages).');
                document.getElementById('loading').classList.add('hidden');
            }
        } catch (err) {
            console.error(err);
            alert('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å Facebook');
        }
    }

    // 4. –ö–ª–∏–µ–Ω—Ç –≤—ã–±—Ä–∞–ª —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ —Å–ø–∏—Å–∫–µ
    function handlePageSelect() {
        const index = document.getElementById('fbPageSelect').value;
        const page = foundPages[index];

        // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è
        document.getElementById('companyName').value = page.name;
        document.getElementById('fbPageId').value = page.id;
        document.getElementById('fbAccessToken').value = page.access_token; // –ö–ª—é—á —Å—Ç—Ä–∞–Ω–∏—Ü—ã!
        
        if (page.instagram_business_account) {
            document.getElementById('igId').value = page.instagram_business_account.id;
        } else {
            document.getElementById('igId').value = '';
        }
    }

    // 5. –ö–Ω–æ–ø–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" - –∑–∞–ø–∏—Å—å –≤ —Ç–≤–æ—é —Ç–∞–±–ª–∏—Ü—É
    document.getElementById('clientForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        const payload = {
            company_name: document.getElementById('companyName').value,
            fb_page_id: document.getElementById('fbPageId').value,
            fb_api_token: document.getElementById('fbAccessToken').value,
            ig_id: document.getElementById('igId').value || null,
            ig_api_token: document.getElementById('fbAccessToken').value, // –î–ª—è IG –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ—Ç –∂–µ —Ç–æ–∫–µ–Ω
            telegram_bot_token: document.getElementById('tgToken').value || null,
            subscription_status: 'active',
            // –°—Ç–∞–≤–∏–º –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è +30 –¥–Ω–µ–π
            subscription_end_date: new Date(new Date().setDate(new Date().getDate() + 30)).toISOString()
        };

        const { error } = await supabase.from('saas_clients').insert([payload]);

        if (error) {
            alert('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ –±–∞–∑—É: ' + error.message + '\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ RLS –≤ Supabase.');
        } else {
            alert('–ì–æ—Ç–æ–≤–æ! –ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω, —Ç–æ–∫–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.');
            // –¢—É—Ç –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å window.location.href = '/dashboard.html';
        }
    });
</script>

</body>
  </html>
    
