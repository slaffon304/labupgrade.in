<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å –®–∞–±–ª–æ–Ω–æ–≤ | LabUpgrade</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        :root {
            --bg-dark: #0f0f0f;
            --bg-panel: #161616;
            --bg-card: #1e1e1e;
            --accent: #0d6efd;
            --text-main: #fff;
            --text-muted: #888;
        }

        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Segoe UI', sans-serif; }

        /* Sidebar */
        .sidebar {
            width: 250px;
            height: 100vh;
            position: fixed;
            background: var(--bg-panel);
            border-right: 1px solid #333;
            padding: 20px;
            z-index: 1000;
        }
        .main-content { margin-left: 250px; padding: 40px; }
        
        .nav-link { color: var(--text-muted); padding: 12px; border-radius: 8px; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; }
        .nav-link:hover, .nav-link.active { background: #333; color: #fff; }
        .nav-link i { font-size: 1.2rem; }

        /* Search Bar */
        .search-bar {
            background: var(--bg-card);
            border: 1px solid #333;
            color: #fff;
            padding: 12px 20px;
            border-radius: 12px;
            width: 100%;
            margin-bottom: 40px;
        }

        /* Cards */
        .template-card {
            background: var(--bg-card);
            border: 1px solid #333;
            border-radius: 16px;
            padding: 24px;
            height: 100%;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        .template-card:hover { transform: translateY(-5px); border-color: var(--accent); }
        
        .card-icon {
            width: 48px; height: 48px;
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; margin-bottom: 20px;
        }
        .bg-blue { background: rgba(13, 110, 253, 0.15); color: #0d6efd; }
        .bg-pink { background: rgba(214, 51, 132, 0.15); color: #d63384; }
        .bg-green { background: rgba(25, 135, 84, 0.15); color: #198754; }
        
        .badge-no-code {
            position: absolute; top: 15px; right: 15px;
            background: #ffc107; color: #000;
            font-size: 10px; font-weight: bold;
            padding: 4px 8px; border-radius: 6px;
            text-transform: uppercase;
        }

        /* Modal */
        .modal-content { background-color: var(--bg-card); border: 1px solid #444; color: #fff; }
        .modal-header { border-bottom: 1px solid #333; }
        .modal-footer { border-top: 1px solid #333; }
        .form-control, .form-select {
            background-color: #2b2b2b; border: 1px solid #444; color: #fff;
        }
        .form-control:focus, .form-select:focus {
            background-color: #333; color: #fff; border-color: var(--accent); box-shadow: none;
        }
        .btn-close { filter: invert(1); }
    </style>
</head>
<body>

<div class="sidebar d-none d-md-block">
    <h4 class="mb-5 px-2">LabUpgrade<span class="text-primary">.AI</span></h4>
    <nav class="nav flex-column">
        <a class="nav-link active" href="#"><i class="bi bi-grid"></i> –®–∞–±–ª–æ–Ω—ã</a>
        <a class="nav-link" href="#"><i class="bi bi-robot"></i> –ú–æ–∏ –ë–æ—Ç—ã</a>
        <a class="nav-link" href="#"><i class="bi bi-people"></i> –ö–ª–∏–µ–Ω—Ç—ã (CRM)</a>
        <a class="nav-link" href="#"><i class="bi bi-gear"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
    </nav>
    <div class="mt-auto pt-5 px-2 text-muted small">
        <div id="userEmail">Loading...</div>
    </div>
</div>

<div class="main-content">
    
    <input type="text" class="search-bar" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ —à–∞–±–ª–æ–Ω–∞–º (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ó–∞–ø–∏—Å—å, CRM, –ü—Ä–æ–¥–∞–∂–∏)...">

    <h5 class="mb-4 text-white"><i class="bi bi-stars text-primary me-2"></i>–ß–∞—Ç-–±–æ—Ç—ã —Å –ò–ò</h5>
    <div class="row g-4 mb-5">
        <div class="col-md-6 col-lg-4">
            <div class="template-card" onclick="openSetup('ai_sales', 'AI –ü—Ä–æ–¥–∞–≤–µ—Ü')">
                <span class="badge-no-code">–ë–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞</span>
                <div class="card-icon bg-blue"><i class="bi bi-robot"></i></div>
                <h5>–ò–ò-–ê–≥–µ–Ω—Ç (–ü—Ä–æ–¥–∞–≤–µ—Ü)</h5>
                <p class="text-muted small mb-0">–û–±—É—á–∞–µ—Ç—Å—è –Ω–∞ –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö. –ö–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–µ—Ç, –ø—Ä–æ–¥–∞–µ—Ç –∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è 24/7.</p>
            </div>
        </div>
        <div class="col-md-6 col-lg-4">
            <div class="template-card" onclick="openSetup('ai_support', 'AI –¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞')">
                <span class="badge-no-code">–ë–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞</span>
                <div class="card-icon bg-blue"><i class="bi bi-life-preserver"></i></div>
                <h5>–ò–ò-–¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞</h5>
                <p class="text-muted small mb-0">–û—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ —á–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã, —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã –∏ –∑–æ–≤–µ—Ç —á–µ–ª–æ–≤–µ–∫–∞ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.</p>
            </div>
        </div>
    </div>

    <h5 class="mb-4 text-white"><i class="bi bi-instagram text-danger me-2"></i>Instagram & CRM</h5>
    <div class="row g-4 mb-5">
        <div class="col-md-6 col-lg-4">
            <div class="template-card" onclick="openSetup('booking', '–ó–∞–ø–∏—Å—å –Ω–∞ —É—Å–ª—É–≥—É')">
                <div class="card-icon bg-pink"><i class="bi bi-calendar-check"></i></div>
                <h5>–ó–∞–ø–∏—Å—å –Ω–∞ —É—Å–ª—É–≥—É</h5>
                <p class="text-muted small mb-0">–ë–æ—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–ª–æ—Ç—ã –≤ Google Calendar –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ —Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è.</p>
            </div>
        </div>
        <div class="col-md-6 col-lg-4">
            <div class="template-card" onclick="openSetup('keyword', '–ë–æ—Ç –Ω–∞ –∫–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ')">
                <div class="card-icon bg-pink"><i class="bi bi-chat-left-text"></i></div>
                <h5>–ê–≤—Ç–æ–æ—Ç–≤–µ—Ç –≤ Direct</h5>
                <p class="text-muted small mb-0">–†–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ —Å–ª–æ–≤–æ "–¶–ï–ù–ê" –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∞–π—Å –≤ –ª–∏—á–∫—É.</p>
            </div>
        </div>
    </div>

</div>

<div class="modal fade" id="setupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">–ù–∞—Å—Ç—Ä–æ–π–∫–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="configForm">
                    <input type="hidden" id="selectedTemplate">
                    
                    <div class="mb-3">
                        <label class="form-label text-muted small">–†–æ–ª—å / –ö–æ–Ω—Ç–µ–∫—Å—Ç (–û–ø–∏—à–∏—Ç–µ –≤–∞—à –±–∏–∑–Ω–µ—Å)</label>
                        <textarea class="form-control" id="businessContext" rows="4" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú—ã —Å—Ç—É–¥–∏—è –¥–µ—Ç–µ–π–ª–∏–Ω–≥–∞. –£—Å–ª—É–≥–∏: –ü–æ–ª–∏—Ä–æ–≤–∫–∞ (100$), –•–∏–º—á–∏—Å—Ç–∫–∞ (50$). –ê–¥—Ä–µ—Å..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-muted small">–¢–æ–Ω –æ–±—â–µ–Ω–∏—è</label>
                        <select class="form-select" id="toneSelect">
                            <option value="friendly">üòä –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π</option>
                            <option value="formal">üëî –î–µ–ª–æ–≤–æ–π</option>
                            <option value="humorous">ü§™ –° —é–º–æ—Ä–æ–º</option>
                        </select>
                    </div>

                    <div class="mb-3 d-none" id="calendarField">
                        <label class="form-label text-muted small">Google Calendar ID</label>
                        <input type="text" class="form-control" id="calendarId" placeholder="example@gmail.com">
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="saveConfiguration()">
                    <i class="bi bi-play-fill"></i> –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    // ==========================================
    // üîë –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–ò –ö–õ–Æ–ß–ò
    // ==========================================
    const SUPABASE_URL = 'https://kdymhrvudosudnqidejj.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtkeW1ocnZ1ZG9zdWRucWlkZWpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzNDAwNTAsImV4cCI6MjA4MTkxNjA1MH0.lXdwDpeIVwI2le8fqfOAVGMmB_IrVnpxexOs43BU0HU';
    // ==========================================

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let currentUser = null;
    let setupModal = null;

    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ö–æ–¥–∞
    window.onload = async () => {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
            window.location.href = '/onboarding.html'; 
        } else {
            currentUser = session.user;
            document.getElementById('userEmail').innerText = currentUser.email;
            setupModal = new bootstrap.Modal(document.getElementById('setupModal'));
        }
    };

    // 2. –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
    function openSetup(templateId, title) {
        document.getElementById('modalTitle').innerText = '–ù–∞—Å—Ç—Ä–æ–π–∫–∞: ' + title;
        document.getElementById('selectedTemplate').value = templateId;
        
        // –õ–æ–≥–∏–∫–∞ –ø–æ–∫–∞–∑–∞ –ø–æ–ª–µ–π
        if(templateId === 'booking') {
            document.getElementById('calendarField').classList.remove('d-none');
        } else {
            document.getElementById('calendarField').classList.add('d-none');
        }
        
        setupModal.show();
    }

    // 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (–°–≤—è–∑—å —Å —Ç–≤–æ–∏–º JSON Backend)
    async function saveConfiguration() {
        const template = document.getElementById('selectedTemplate').value;
        const context = document.getElementById('businessContext').value;
        const tone = document.getElementById('toneSelect').value;
        const calendarId = document.getElementById('calendarId').value;

        // –ú–∞–ø–ø–∏–Ω–≥ —à–∞–±–ª–æ–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î (–¥–ª—è —Ç–≤–æ–µ–≥–æ n8n)
        let updateData = {
            business_context: context,
            tone: tone,
            updated_at: new Date()
        };

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ü–µ–ª—å –±–æ—Ç–∞
        if (template === 'ai_sales') updateData.bot_goal = 'sales';
        if (template === 'ai_support') updateData.bot_goal = 'support';
        if (template === 'booking') {
            updateData.bot_goal = 'booking';
            updateData.google_calendar_id = calendarId;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ saas_clients
        // –í–ê–ñ–ù–û: –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —É —é–∑–µ—Ä–∞ –æ–¥–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—è –∑–∞–ø–∏—Å—å. 
        // –ò—â–µ–º –ø–æ owner_id (–∫–æ—Ç–æ—Ä—ã–π –º—ã –¥–æ–±–∞–≤–∏–ª–∏ –≤ SQL —Ä–∞–Ω–µ–µ)
        
        const { error } = await supabase
            .from('saas_clients')
            .update(updateData)
            .eq('owner_id', currentUser.id);

        if (error) {
            alert('–û—à–∏–±–∫–∞: ' + error.message);
        } else {
            setupModal.hide();
            alert('‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–Ω–∞—Å—Ç—Ä–æ–µ–Ω! –¢–µ–ø–µ—Ä—å –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–µ–∂–∏–º–µ: ' + template);
        }
    }
</script>

</body>
</html>

